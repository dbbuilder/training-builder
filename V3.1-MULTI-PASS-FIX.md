# Training Builder v3.1 - Multi-Pass Exercises & Instructor Keys

## Problem Detected in Current Run (v3.0)

While monitoring the production generation (Chapter 5 of 20), we noticed:

1. **Exercises with ellipsis/truncation** - Check/edit workflow detecting incomplete code
2. **Inconsistent instructor keys** - Some 6KB (good), some 1.3KB (too small)

These issues occur because we're trying to generate too much content in a single pass.

---

## Root Cause Analysis

**Book chapters work perfectly** because they use multi-pass generation:
- Pass 1: Outline
- Pass 2-6: Individual sections (each gets full 8000 tokens)
- Pass 7: Combine

**Exercises and instructor keys fail** because they try to generate everything in one pass:
- Single 8000 token pass → runs out of tokens → uses ellipsis/truncation

---

## Solution: Multi-Pass Generation

Apply the same multi-pass strategy that works for book chapters to exercises and instructor keys.

### Multi-Pass Exercises (3 steps)

**Before (Single Pass):**
```javascript
// Generate all 3-5 exercises in one API call
const message = await anthropic.messages.create({
  max_tokens: 8000,
  messages: [{ role: 'user', content: prompt }]
});
// Problem: Runs out of tokens, truncates exercises 3-5
```

**After (Multi-Pass):**
```javascript
// PASS 1: Generate outline (2000 tokens)
const outline = await generateOutline();

// PASS 2: Generate exercises 1-2 (8000 tokens)
const exercises12 = await generateExercises([1, 2], outline);

// PASS 3: Generate exercises 3-5 (8000 tokens)
const exercises35 = await generateExercises([3, 4, 5], outline);

// Combine for total ~18KB of complete exercises
```

**Benefits:**
- Each exercise gets adequate token budget
- Complete code in all exercises
- No ellipsis or truncation
- Expected size: 8-10KB (vs 5-7KB before)

### Multi-Pass Instructor Keys (3 steps)

**Before (Single Pass):**
```javascript
// Generate all instructor materials in one call
const message = await anthropic.messages.create({
  max_tokens: 8000,
  messages: [{ role: 'user', content: prompt }]
});
// Problem: Small output (1.3KB) or truncated solutions
```

**After (Multi-Pass):**
```javascript
// PASS 1: Generate outline (1500 tokens)
const outline = await generateOutline();

// PASS 2: Generate complete exercise solutions (8000 tokens)
// This is the most code-heavy part, gets dedicated pass
const exerciseSolutions = await generateSolutions(outline);

// PASS 3: Generate quiz answers + grading guidelines (8000 tokens)
const quizAndGuidelines = await generateQuizAndGuidelines(outline);

// Combine for total ~12-15KB of comprehensive instructor materials
```

**Benefits:**
- Exercise solutions get full implementation (3-4KB)
- Quiz answers get detailed explanations (2-3KB)
- Grading guidelines get comprehensive checklists (1-2KB)
- Expected size: 6-8KB consistently (vs 1.3-6KB inconsistent before)

---

## Implementation Details

### Exercise Generator Changes

`/mnt/d/dev2/claude-agent-sdk/training-builder/generators/exercise-generator.js`

**Added:**
- Multi-pass generation (3 API calls instead of 1)
- Explicit anti-truncation warnings at top of prompt
- Increased code snippet length limit (30 → 50 lines) with emphasis on COMPLETE
- Final verification checklist in prompt

**API Calls:**
- Before: 1 call @ 8000 tokens = 8000 tokens
- After: 3 calls @ (2000 + 8000 + 8000) = 18000 tokens
- Cost increase: ~$0.01 per chapter (worth it for complete exercises)

### Instructor Keys Generator Changes

`/mnt/d/dev2/claude-agent-sdk/training-builder/generators/instructor-keys-generator.js`

**Added:**
- Multi-pass generation (3 API calls instead of 1)
- Explicit size target (4-6KB minimum) in prompt
- Detailed section-by-section requirements
- Separate pass for code-heavy exercise solutions

**API Calls:**
- Before: 1 call @ 8000 tokens = 8000 tokens
- After: 3 calls @ (1500 + 8000 + 8000) = 17500 tokens
- Cost increase: ~$0.01 per chapter (worth it for comprehensive materials)

---

## Expected Impact

### Quality Improvements

| Component | Before (v3.0) | After (v3.1) | Improvement |
|-----------|---------------|--------------|-------------|
| Exercises size | 5-7KB | 8-10KB | 40% larger |
| Exercises completeness | 70% (ellipsis detected) | 100% complete | ✅ Fixed |
| Instructor keys size | 1.3-6KB (inconsistent) | 6-8KB (consistent) | ✅ Consistent |
| Instructor keys quality | Mixed | Comprehensive | ✅ Improved |

### Cost Impact

**Per Chapter:**
- Exercises: +$0.01 (3 calls vs 1 call)
- Instructor keys: +$0.01 (3 calls vs 1 call)
- **Total increase: +$0.02 per chapter**

**For 20 Chapters:**
- Current cost: ~$2.04
- New cost: ~$2.44 (+$0.40)
- **Still under budget, worth it for quality**

### Time Impact

**Sequential Generation:**
- Before: ~90 minutes for 20 chapters
- After: ~100 minutes for 20 chapters (+10 minutes)

**Parallel Generation (--parallel 4):**
- Before: ~25 minutes for 20 chapters
- After: ~28 minutes for 20 chapters (+3 minutes)
- **Minimal time increase with parallel mode**

---

## Files Modified

1. `generators/exercise-generator.js` - Implemented 3-pass generation
2. `generators/instructor-keys-generator.js` - Implemented 3-pass generation
3. `V3.1-MULTI-PASS-FIX.md` - This documentation

---

## Testing Plan

1. **Generate single chapter** to verify multi-pass works:
   ```bash
   node index.js generate --chapter 1
   ```

2. **Check output sizes:**
   ```bash
   ls -lh output/chapter-01/exercises.txt       # Should be 8-10KB
   ls -lh output/chapter-01/instructor-keys.txt  # Should be 6-8KB
   ```

3. **Verify no ellipsis:**
   ```bash
   grep -c "\.\.\." output/chapter-01/exercises.txt  # Should be 0
   ```

4. **Check generation logs:**
   - Should show "Multi-pass exercise generation (3 steps)"
   - Should show "Multi-pass instructor keys generation (3 steps)"

---

## Status: READY FOR NEXT RUN ✅

All fixes implemented and ready for the next generation run. The current production run (Chapter 5 of 20) will complete with the old code, but the next run will use these multi-pass improvements.

**Next run command:**
```bash
node index.js generate --all --parallel 4
```

**Expected results:**
- Complete exercises with no ellipsis
- Consistent 6-8KB instructor keys
- ~28 minutes total time
- ~$2.44 total cost
- 100% professional quality throughout

---

## Why This Works

**The Pattern:**
Book chapters have been generating perfectly at 19-20KB because they use multi-pass generation. This proves the approach works.

**The Fix:**
Apply the same proven strategy to exercises and instructor keys.

**The Result:**
Consistent, complete, professional-quality content across ALL components.

---

## Version History

- **v3.0** - Quick wins + code validation + parallel generation
- **v3.1** - Multi-pass exercises and instructor keys (this update)

**Next:** v3.2 could add auto-fix for truncation detection (Medium ROI improvement from FUTURE-IMPROVEMENTS.md)
